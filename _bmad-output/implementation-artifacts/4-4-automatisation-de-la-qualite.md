# Story 4.4: Automatisation de la Qualité (Lint & Test)

Status: review

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a développeur,
I want lancer les tests et le linter via une seule commande,
so that je puisse garantir la qualité de mon code rapidement et uniformément.

## Acceptance Criteria

1.  **Linter Standardisé**
    *   **Given** J'ai du code qui ne respecte pas les standards (ex: variables inutilisées, erreurs non gérées).
    *   **When** J'exécute la commande de linting.
    *   **Then** Le linter détecte et signale les erreurs.
    *   **And** La configuration est centralisée dans un fichier `.golangci.yml`.

2.  **Exécution des Tests**
    *   **Given** J'ai des tests unitaires et d'intégration.
    *   **When** J'exécute `make test`.
    *   **Then** Tous les tests sont lancés (avec détection de race conditions si possible).
    *   **And** Un rapport de couverture sommaire est affiché.

3.  **Commandes Makefile**
    *   **Given** Je suis à la racine du projet.
    *   **When** Je tape `make help`.
    *   **Then** Je vois les nouvelles commandes `lint`, `test`, `test-coverage`.

4.  **Intégration CLI**
    *   **Given** Je génère un nouveau projet.
    *   **Then** Le fichier `.golangci.yml` est présent par défaut.
    *   **And** Le Makefile inclut déjà les commandes de qualité.

## Tasks / Subtasks

- [x] **Linter Configuration (`manual-test-project`)**
    - [x] Créer `.golangci.yml` à la racine.
    - [x] Activer les linters critiques : `govet`, `errcheck`, `staticcheck`, `unused`, `gosec` (basic), `gofmt`.
    - [x] Configurer les exclusions si nécessaire (ex: dossiers de tests pour certaines règles).

- [x] **Makefile Enhancements (`manual-test-project`)**
    - [x] Ajouter `lint`: exécuter `golangci-lint run`.
    - [x] Ajouter `test`: exécuter `go test -race ./...`.
    - [x] Ajouter `test-coverage`: générer un rapport HTML.

- [x] **CLI Generator Update**
    - [x] Ajouter le template `.golangci.yml` dans `templates.go`.
    - [x] Mettre à jour le template `Makefile` dans `templates.go`.

- [x] **Verification**
    - [x] Introduire volontairement une erreur de linting et vérifier que `make lint` échoue.
    - [x] Vérifier que `make test` lance bien les tests existants.

## Dev Notes

### GolangCI-Lint Config Example (`.golangci.yml`)

```yaml
run:
  timeout: 5m
  tests: false # Don't lint test files strictly

linters:
  disable-all: true
  enable:
    - errcheck
    - gosimple
    - govet
    - ineffassign
    - staticcheck
    - typecheck
    - unused
    - gocyclo
    - gofmt

linters-settings:
  gocyclo:
    min-complexity: 15
```

### Makefile Commands

```makefile
.PHONY: lint test test-coverage

lint:
	@echo "Running linter..."
	@golangci-lint run ./...

test:
	@echo "Running tests..."
	@go test -v -race ./...

test-coverage:
	@echo "Running tests with coverage..."
	@go test -v -race -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
```

### Pre-requisites
- The developer is expected to have `golangci-lint` installed globally or locally. The README generated by the CLI should mention how to install it (`go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.60.1`).

### Architecture Compliance
- **NFR8:** Enforces `golangci-lint`.
- **FR24:** Enforces single command test execution.

## Dev Agent Record

### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
- Verified Architecture requirements for linting.
- Checked standard Makefile patterns for Go.

### Completion Notes List
- [x] .golangci.yml created in manual-test-project with critical linters enabled (errcheck, gosimple, govet, ineffassign, staticcheck, typecheck, unused, gocyclo, gofmt, gosec).
- [x] Makefile updated in manual-test-project with lint, test (with -race), and test-coverage commands.
- [x] CLI templates updated: Added GolangCILintTemplate() in templates.go and updated MakefileTemplate() with new quality commands.
- [x] Generator.go updated to include .golangci.yml in generated files.
- [x] Verified lint command detects errors and test command runs with race detection.
- [x] Fixed linting errors in existing code (removed unused imports, added negative number checks before int->uint conversions).

### File List
- manual-test-project/.golangci.yml
- manual-test-project/Makefile
- cmd/create-go-starter/templates.go
- cmd/create-go-starter/generator.go
- manual-test-project/internal/adapters/handlers/auth_handler.go
- manual-test-project/internal/adapters/handlers/user_handler.go

## Change Log
- **2026-01-09**: Implemented automated quality tools (lint and test commands) for the project. Added .golangci.yml configuration with critical linters. Updated Makefile with lint, test, and test-coverage commands. Updated CLI generator to include quality automation in new projects. Fixed existing linting errors in codebase.
